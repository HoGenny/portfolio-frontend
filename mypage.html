<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>마이페이지</title>
  <style>
    :root {
      --blue: #3182f6;
      --light-bg: #f9fafb;
      --text: #1e1e1e;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--light-bg);
      color: var(--text);
      line-height: 1.6;
    }
    .logo {
      position: fixed;
      top: -0.5rem;
      left: 1.2rem;
      z-index: 1000;
    }
    .logo img {
      height: 95px;
      width: auto;
      user-select: none;
    }
    .container {
      max-width: 1000px;
      margin: 6rem auto 3rem;
      padding: 1rem;
    }
    .profile-section {
      display: flex;
      align-items: center;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    .profile-pic {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #ddd;
    }
    .profile-info {
      flex: 1;
    }
    .profile-info h2 {
      font-size: 1.8rem;
      margin-bottom: 0.3rem;
    }
    .profile-info p {
      color: #555;
      font-size: 1rem;
      margin-bottom: 0.3rem;
    }
    .edit-btn {
      background-color: var(--blue);
      color: white;
      padding: 0.4rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    .portfolio-section {
      margin-top: 2rem;
      display: none;
    }
    .portfolio-section.active {
      display: block;
    }
    .portfolio-section h3 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
    }
    .portfolio-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1.2rem;
    }
    .portfolio-item {
      background-color: white;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      text-align: center;
      cursor: pointer;
    }
    .portfolio-item img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    .portfolio-item-title {
      font-size: 1rem;
      font-weight: 500;
    }
    .no-portfolio {
      text-align: center;
      color: #888;
      margin-top: 1rem;
    }
    iframe {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin-top: 2rem;
    }
    .btn {
      padding: 0.5rem 1rem;
      background-color: #3182f6;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 0.5rem;
    }
    .btn.delete {
      background-color: #e11d48;
    }
  </style>
</head>
<body>
  <a href="index.html" class="logo">
    <img src="static/images/logo.png" alt="로고">
  </a>
  <div class="container">
    <div class="profile-section">
      <img src="static/images/default-profile.png" alt="" class="profile-pic" id="profile-pic">
      <div class="profile-info">
        <h2 id="username">이름</h2>
        <p id="bio">한 줄 소개가 여기에 표시됩니다.</p>
        <p id="birthdate">생년월일: </p>
        <button class="edit-btn" onclick="location.href='/edit-profile.html'">프로필 수정
        </button>
      </div>
    </div>

    <div class="portfolio-section" id="portfolio-section">
      <h3>포트폴리오 목록</h3>
      <div class="portfolio-list" id="portfolio-list"></div>
      <div class="no-portfolio" id="no-portfolio" style="display: none;">저장된 포트폴리오가 없습니다.</div>
    </div>

    <div id="personal-preview"></div>
    <div id="personal-buttons" style="margin-top: 1rem;"></div>
  </div>

  <script>
    const API_BASE = "https://portfolio-backend-6op9.onrender.com";
    const user = JSON.parse(localStorage.getItem("user"));

    if (!user) {
      alert("로그인 후 이용 가능합니다.");
      window.location.href = "login.html";
    } else {
        // 생년월일 포맷 수정
        let formattedBirthdate = "-";
        if (user.birthdate) {
          const date = new Date(user.birthdate);
          formattedBirthdate = date.toISOString().slice(0, 10);
        }
  
        // 정보 표시
        document.getElementById("username").textContent = user.realname || user.username;
        document.getElementById("birthdate").textContent = "생년월일: " + formattedBirthdate;
        document.getElementById("bio").textContent = user.bio || "한 줄 소개가 여기에 표시됩니다.";

        loadServerPortfolios();
      }
  
      async function loadServerPortfolios() {
      try {
        const response = await fetch(`${API_BASE}/api/portfolios?user=${user.username}`);
        const files = await response.json();
  
        const portfolioSection = document.getElementById("portfolio-section");
        const portfolioList = document.getElementById("portfolio-list");
        const noPortfolio = document.getElementById("no-portfolio");
  
        if (files.length > 0) {
          portfolioSection.classList.add("active");
          files.forEach(file => {
            const card = document.createElement("div");
            card.className = "portfolio-item";
  
            card.innerHTML = `
              <div style="width:100%; height:200px; overflow:hidden; border-radius:8px; border:1px solid #ddd;">
                <iframe src="${API_BASE}/api/portfolios/${file.filename}" style="transform:scale(0.6); transform-origin: top left; width:166.67%; height:333px; border:none;"></iframe>
              </div>
              <div class="portfolio-item-title">${file.title}</div>
              <button class="btn" onclick="editPortfolio('${file.filename}')">편집</button>
              <button class="btn delete" onclick="deletePortfolio('${file.filename}')">삭제</button>
            `;
  
            portfolioList.appendChild(card);
          });
        } else {
          portfolioSection.classList.add("active");
          noPortfolio.style.display = "block";
        }
      } catch (err) {
        console.error('포트폴리오 목록 불러오기 실패:', err);
      }
    }
  
    async function deletePortfolio(filename) {
      if (!confirm("정말 이 포트폴리오를 삭제하시겠습니까?")) return;

      try {
        const response = await fetch(`${API_BASE}/api/portfolios/${filename}`, {
          method: "DELETE"
        });

        const text = await response.text();

        if (!response.ok) {
          alert("삭제 실패: " + text);
          return;
        }

        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          alert("삭제는 되었지만 서버 응답을 해석할 수 없습니다.");
          return;
        }

        alert("포트폴리오가 삭제되었습니다.");
        window.location.reload();

      } catch (err) {
        console.error("삭제 요청 오류:", err);
        alert("서버와의 연결에 실패했습니다.");
      }
    }

  
    function editPortfolio(filename) {
      window.location.href = `edit-portfolio-form.html?file=${filename}`;
    }
  
    function viewPortfolio(filename) {
      window.location.href = `${API_BASE}/portfolios/${filename}`;
    }
  </script>   
</body>
</html>